<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ค้นหา LINE Sticker</title>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Mitr', sans-serif;
            padding: 20px;
            text-align: center;
            margin: 0;
            background: linear-gradient(135deg, #ffe6f0 0%, #e6f9f0 100%);
            font-size: 16px;
            color: #333;
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://www.transparenttextures.com/patterns/45-degree-fabric-light.png');
            opacity: 0.1;
            z-index: -1;
        }
        h1 {
            font-size: 28px;
            color: #ff5e84;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
            position: relative;
        }
        h1::before {
            content: '✨';
            position: absolute;
            left: -30px;
            top: 5px;
        }
        h1::after {
            content: '✨';
            position: absolute;
            right: -30px;
            top: 5px;
        }
        input, button {
            padding: 10px;
            margin: 10px;
            font-size: 16px;
            border-radius: 15px;
            border: none;
            width: 90%;
            max-width: 320px;
            box-sizing: border-box;
            font-family: 'Mitr', sans-serif;
        }
        input {
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 2px solid #ffccde;
        }
        input:focus {
            outline: none;
            border-color: #ff5e84;
        }
        button {
            background: linear-gradient(45deg, #ff5e84, #ff8ab5);
            color: white;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            background: linear-gradient(45deg, #ff8ab5, #ff5e84);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
        }
        #result {
            margin-top: 20px;
            background-color: #fff;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        #main {
            display: none;
        }
        #stickerImage {
            max-width: 180px;
            margin: 15px auto;
            border-radius: 15px;
            border: 3px solid #ffccde;
        }
        #previewGallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px;
            margin: 15px 0;
        }
        #previewGallery img {
            width: 100%;
            height: 70px;
            object-fit: contain;
            border: 2px solid #e6f9f0;
            border-radius: 10px;
            transition: transform 0.2s;
        }
        #previewGallery img:hover {
            transform: scale(1.1);
        }
        #loadingSearch {
            display: none;
            font-size: 16px;
            color: #ff5e84;
            margin: 10px 0;
        }
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #ffccde;
            border-top: 5px solid #ff5e84;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #shareLoader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ffccde 0%, #d9f7e6 100%);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
        }
        .heart-spinner {
            width: 60px;
            height: 60px;
            position: relative;
            animation: pulse 1.5s ease-in-out infinite;
        }
        .heart-spinner::before,
        .heart-spinner::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #ff5e84;
            border-radius: 50%;
            top: 15px;
        }
        .heart-spinner::before {
            left: 0;
        }
        .heart-spinner::after {
            right: 0;
        }
        .heart-spinner .heart-body {
            width: 30px;
            height: 30px;
            background-color: #ff5e84;
            position: absolute;
            top: 30px;
            left: 15px;
            transform: rotate(45deg);
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        #preloader p, #shareLoader p {
            font-size: 18px;
            color: #ff5e84;
            font-weight: 400;
            margin-top: 20px;
        }
        .coin-icon {
            width: 50px;
            vertical-align: middle;
            margin-right: 5px;
        }
        p, h4 {
            color: #555;
            margin: 10px 0;
        }
        h4 {
            color: #ff5e84;
            font-size: 18px;
            margin-top: 15px;
        }
        .region-info {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
        }
        .region-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        .format-info {
            background-color: #f0f8ff;
            padding: 8px;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 12px;
            color: #666;
        }
        /* Responsive adjustments */
        @media (min-width: 768px) {
            h1 {
                font-size: 36px;
            }
            input, button {
                max-width: 400px;
            }
            #result {
                max-width: 800px;
                padding: 30px;
            }
            #previewGallery {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 12px;
            }
            #previewGallery img {
                height: 100px;
            }
            #stickerImage {
                max-width: 250px;
            }
        }
        @media (max-width: 480px) {
            h1 {
                font-size: 24px;
            }
            input, button {
                max-width: 280px;
            }
            #previewGallery {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
                gap: 6px;
            }
            #previewGallery img {
                height: 60px;
            }
        }
    </style>
</head>
<body>
    <div id="preloader">
        <div class="spinner"></div>
        <p>กำลังโหลดแอป...</p>
    </div>

    <div id="shareLoader">
        <div class="heart-spinner">
            <div class="heart-body"></div>
        </div>
        <p>✨ กำลังส่ง Sticker น่ารัก ๆ ให้เพื่อน ✨</p>
    </div>

    <div id="main">
        <h1>ค้นหา LINE Sticker</h1>
        <input type="number" id="stickerId" placeholder="ป้อน Sticker ID เช่น 31552153">
        <button onclick="searchSticker()">ค้นหา</button>
        <div id="loadingSearch">กำลังค้นหา...</div>
        <div id="result"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function escapeHtml(str) {
            return str.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function extractProductJsonLd(htmlText) {
            const scriptRegex = /<script type="application\/ld\+json">(.*?)<\/script>/gs;
            let match;
            while ((match = scriptRegex.exec(htmlText)) !== null) {
                try {
                    const json = JSON.parse(match[1].trim());
                    if (json['@type'] === 'Product') {
                        return json;
                    }
                } catch (error) {
                    console.error('Error parsing JSON-LD:', error);
                }
            }
            return null;
        }

        async function initializeLiff() {
            console.log('Starting LIFF initialization');
            if (typeof liff === 'undefined') {
                console.warn('LIFF SDK not loaded, skipping initialization');
                return false;
            }

            try {
                console.log('Initializing LIFF with ID: 2000563749-VxLJ4OdX');
                await liff.init({ liffId: '2000563749-VxLJ4OdX' });
                console.log('LIFF initialized successfully');

                await liff.ready;
                console.log('LIFF is ready');
                return true;
            } catch (error) {
                console.error('LIFF init error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'การเริ่มต้น LIFF ล้มเหลว',
                    text: 'ไม่สามารถเริ่มต้น LIFF ได้: ' + error.message,
                    confirmButtonText: 'ตกลง'
                });
                return false;
            }
        }

        async function checkStickerExists(stickerId) {
            const imageUrl = `https://stickershop.line-scdn.net/stickershop/v1/product/${stickerId}/LINEStorePC/main.png`;
            try {
                const response = await fetch(imageUrl, { 
                    method: 'HEAD', 
                    cache: 'no-store'
                });
                if (!response.ok) {
                    throw new Error(`Sticker not found (status: ${response.status})`);
                }
                return true;
            } catch (error) {
                console.error('Check sticker error:', error);
                return false;
            }
        }

        async function fetchStickerPage(stickerId, lang, attempt = 1, maxAttempts = 3) {
            const storeUrl = `https://store.line.me/stickershop/product/${stickerId}/${lang}`;
            const proxy = 'https://api.allorigins.win/raw?url=';
            const fallbackProxy = 'https://corsproxy.io/?';
            const proxyUrl = attempt === 1 ? proxy : fallbackProxy;

            try {
                console.log(`Fetching ${storeUrl} via ${proxyUrl} (Attempt ${attempt})`);
                const response = await fetch(proxyUrl + encodeURIComponent(storeUrl), {
                    method: 'GET',
                    cache: 'no-store',
                    headers: {
                        'Accept': 'text/html',
                        'Accept-Language': lang === 'th' ? 'th-TH,th;q=0.9' : lang === 'jp' ? 'ja-JP,ja;q=0.9' : 'en-US,en;q=0.9'
                    },
                    signal: AbortSignal.timeout(10000)
                });
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                const text = await response.text();
                if (text.includes('<title>LINE STORE</title>') || text.includes('cf-error-details')) {
                    throw new Error('Invalid response or Cloudflare block');
                }
                return text;
            } catch (error) {
                console.error(`Fetch error for ${lang} (Attempt ${attempt}):`, error.message);
                if (attempt < maxAttempts) {
                    console.log(`Retrying with attempt ${attempt + 1}`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return fetchStickerPage(stickerId, lang, attempt + 1, maxAttempts);
                }
                return null;
            }
        }

        function createFlexMessage(url, title, author, coins, imageUrl, stickerFormat, priceDisplay, liffId) {
            return {
                type: "bubble",
                size: "kilo",
                header: {
                    type: "box",
                    layout: "horizontal",
                    contents: [
                        {
                            type: "image",
                            url: "https://aliyahaunjo.github.io/image/LINE-COIN.png",
                            size: "xxs",
                            align: "start",
                            flex: 0
                        },
                        {
                            type: "text",
                            text: "STICKER By ❤️ครูอั๋น ใจดี❤️",
                            size: "xs",
                            color: "#FFFFFF",
                            weight: "bold",
                            gravity: "center",
                            offsetStart: "sm"
                        }
                    ],
                    backgroundColor: "#00C300",
                    maxHeight: "65px"
                },
                hero: {
                    type: "image",
                    url: imageUrl,
                    size: "lg",
                    aspectRatio: "1:1",
                    aspectMode: "fit",
                    align: "center",
                    offsetTop: "md",
                    backgroundColor: "#FFFFFF"
                },
                body: {
                    type: "box",
                    layout: "vertical",
                    contents: [
                        {
                            type: "text",
                            text: title,
                            size: "md",
                            weight: "bold",
                            wrap: true,
                            maxLines: 2,
                            color: "#333333",
                            align: "center"
                        },
                        {
                            type: "text",
                            text: `ผู้สร้าง: ${author}`,
                            size: "sm",
                            color: "#666666",
                            wrap: true,
                            maxLines: 1,
                            align: "center",
                            margin: "xs"
                        },
                        {
                            type: "box",
                            layout: "vertical",
                            contents: [
                                {
                                    type: "text",
                                    text: `รูปแบบ: ${stickerFormat}`,
                                    size: "xs",
                                    color: "#00C300",
                                    wrap: true,
                                    gravity: "center",
                                    align: "start",
                                    weight: "bold"
                                }
                            ],
                            margin: "sm",
                            backgroundColor: "#F5F5F5",
                            cornerRadius: "md",
                            offsetStart: "md",
                            paddingAll: "md",
                            maxWidth: "228px"
                        },
                        {
                            type: "box",
                            layout: "horizontal",
                            contents: coins > 0 ? [
                                {
                                    type: "image",
                                    size: "xxs",
                                    margin: "sm",
                                    gravity: "center",
                                    align: "center",
                                    url: "https://aliyahaunjo.github.io/image/LINE-COIN.png"
                                },
                                {
                                    type: "text",
                                    text: `${coins} coins (~${priceDisplay} THB)`,
                                    size: "sm",
                                    color: "#FFAA00",
                                    weight: "bold",
                                    gravity: "center",
                                    align: "start",
                                    flex: 3
                                }
                            ] : [
                                {
                                    type: "text",
                                    text: "ฟรี",
                                    size: "sm",
                                    color: "#00C300",
                                    weight: "bold",
                                    gravity: "center",
                                    align: "center",
                                    flex: 2
                                }
                            ],
                            backgroundColor: "#FFFFFF",
                            cornerRadius: "md",
                            maxHeight: "50px",
                            margin: "sm",
                            paddingAll: "sm",
                            maxWidth: "250px",
                            justifyContent: coins > 0 ? "flex-start" : "center"
                        },
                        {
                            type: "text",
                            text: "ราคาเปลี่ยนแปลงตามโปรโมชั่น",
                            size: "xs",
                            color: "#666666",
                            align: "center",
                            margin: "sm"
                        },
                        {
                            type: "button",
                            style: "primary",
                            color: "#FF4444",
                            action: {
                                type: "uri",
                                label: "ซื้อสติกเกอร์",
                                uri: url
                            },
                            height: "sm",
                            margin: "md"
                        },
                        {
                            type: "box",
                            layout: "horizontal",
                            contents: [
                                {
                                    type: "button",
                                    style: "primary",
                                    color: "#00C300",
                                    height: "sm",
                                    action: {
                                        type: "uri",
                                        label: "ร้านค้า",
                                        uri: "https://store.line.me/search/en?q=kruaun+jaidee"
                                    },
                                    margin: "sm"
                                },
                                {
                                    type: "button",
                                    style: "secondary",
                                    height: "sm",
                                    action: {
                                        type: "uri",
                                        label: "แชร์",
                                        uri: `https://liff.line.me/${liffId}?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}&author=${encodeURIComponent(author)}&coins=${encodeURIComponent(coins)}&imageUrl=${encodeURIComponent(imageUrl)}&stickerFormat=${encodeURIComponent(stickerFormat)}&priceTHB=${encodeURIComponent(priceDisplay)}`
                                    },
                                    margin: "sm"
                                }
                            ],
                            margin: "md",
                            alignItems: "center",
                            justifyContent: "center"
                        }
                    ],
                    paddingAll: "md",
                    backgroundColor: "#FFFFFF"
                },
                styles: {
                    footer: {
                        separator: true,
                        separatorColor: "#DDDDDD"
                    }
                }
            };
        }

        async function getAllStickerImages(stickerId, htmlText) {
            const previewImages = [];
            const stickerIds = [];
            
            try {
                const doc = new DOMParser().parseFromString(htmlText, 'text/html');
                
                // Method 1: Extract from .FnStickerList
                const stickerWrap = doc.querySelector('.mdCMN09Ul.FnStickerList');
                if (stickerWrap) {
                    const items = stickerWrap.querySelectorAll('.FnStickerPreviewItem');
                    items.forEach(item => {
                        const dataPreview = item.getAttribute('data-preview');
                        if (dataPreview) {
                            try {
                                const parsed = JSON.parse(dataPreview.replace(/'/g, '"'));
                                // Try all available formats
                                const urls = [
                                    parsed.staticUrl,
                                    parsed.animationUrl, 
                                    parsed.soundUrl,
                                    parsed.fallbackStaticUrl
                                ].filter(url => url && url.includes('stickershop'));
                                
                                if (urls.length > 0) {
                                    previewImages.push(urls[0]);
                                    stickerIds.push(parsed.id || '');
                                }
                            } catch (error) {
                                console.error('JSON parse error:', error.message);
                            }
                        }
                    });
                }

                // Method 2: Extract from all sticker images if we have less than 8
                if (previewImages.length < 8) {
                    const allImages = doc.querySelectorAll('img[src*="stickershop"]');
                    allImages.forEach(img => {
                        const src = img.src;
                        if (src && (
                            src.includes('sticker/') ||
                            src.includes('sticker_animation/') ||
                            src.includes('sticker_popup/') ||
                            src.includes('sticker_effect/')
                        ) && !previewImages.includes(src)) {
                            previewImages.push(src);
                            const match = src.match(/sticker\/(\d+)/);
                            stickerIds.push(match ? match[1] : '');
                        }
                    });
                }

                // Method 3: Generate URLs if still insufficient
                if (previewImages.length < 8) {
                    console.log('Generating additional sticker URLs...');
                    for (let i = 1; i <= 40; i++) {
                        if (previewImages.length >= 40) break;
                        
                        const formats = [
                            `https://stickershop.line-scdn.net/stickershop/v1/sticker/${stickerId}/${i}/iPhone/sticker.png`,
                            `https://stickershop.line-scdn.net/stickershop/v1/sticker/${stickerId}/${i}/android/sticker.png`,
                            `https://stickershop.line-scdn.net/stickershop/v1/sticker/${stickerId}/${i}/ANDROID/sticker.png`
                        ];
                        
                        for (const url of formats) {
                            if (!previewImages.includes(url)) {
                                previewImages.push(url);
                                stickerIds.push(i.toString());
                                break;
                            }
                        }
                    }
                }

            } catch (error) {
                console.error('Error extracting sticker images:', error);
            }

            return { previewImages: previewImages.slice(0, 40), stickerIds: stickerIds.slice(0, 40) };
        }

        function detectStickerFormat(previewImages) {
            if (previewImages.some(url => url.includes('animation') || url.includes('APNG'))) {
                if (previewImages.some(url => url.includes('sound'))) {
                    return 'ANIMATION_SOUND';
                }
                return 'ANIMATION';
            }
            return 'STATIC';
        }

        async function searchSticker() {
            const stickerId = document.getElementById('stickerId').value.trim();

            if (!stickerId || isNaN(stickerId)) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Sticker ID ไม่ถูกต้อง',
                    text: 'กรุณาป้อน Sticker ID ที่เป็นตัวเลข',
                    confirmButtonText: 'ตกลง'
                });
                return;
            }

            const loadingSearch = document.getElementById('loadingSearch');
            const resultDiv = document.getElementById('result');
            loadingSearch.style.display = 'block';
            resultDiv.innerHTML = '';

            try {
                if (!(await checkStickerExists(stickerId))) {
                    throw new Error(`ไม่พบสติกเกอร์สำหรับ ID: ${stickerId} (อาจถูกลบหรือจำกัดภูมิภาค)`);
                }

                const imageUrl = `https://stickershop.line-scdn.net/stickershop/v1/product/${stickerId}/LINEStorePC/main.png`;
                const languages = ['th', 'en', 'jp'];
                let regionData = {};
                let selectedLang = null;
                let bestHtmlText = null;

                for (const lang of languages) {
                    const htmlText = await fetchStickerPage(stickerId, lang);
                    if (htmlText) {
                        if (!bestHtmlText) bestHtmlText = htmlText;
                        
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(htmlText, 'text/html');
                        const jsonLd = extractProductJsonLd(htmlText);

                        let title = doc.querySelector('title')?.textContent.trim() || 'ไม่พบชื่อ';
                        if (title.includes('– สติกเกอร์ LINE | LINE STORE')) {
                            title = title.split('– สติกเกอร์ LINE | LINE STORE')[0].trim();
                        }
                        let author = jsonLd?.author?.name || jsonLd?.offers?.seller?.name || doc.querySelector('[data-test="sticker-author"]')?.textContent.trim() || 'ไม่พบผู้สร้าง';
                        let description = jsonLd?.description || doc.querySelector('.mdCMN38Item01Txt')?.textContent.trim() || 'ไม่มีรายละเอียด';
                        let price = jsonLd?.offers?.price || doc.querySelector('.mdCMN38Item01Price')?.textContent.trim() || 'ไม่พบราคา';
                        let priceCurrency = jsonLd?.offers?.priceCurrency || 'THB';
                        let coins = 0;

                        // Convert price to coins (approximation: 1 THB ≈ 2 Coins)
                        if (price && !isNaN(parseFloat(price))) {
                            coins = Math.round(parseFloat(price) * 2);
                        } else if (price.toLowerCase().includes('free')) {
                            coins = 0;
                            price = '0';
                        }

                        regionData[lang] = {
                            title,
                            author,
                            price: `${price} ${priceCurrency}`,
                            description,
                            coins
                        };

                        if (!selectedLang) {
                            selectedLang = lang;
                        }
                    } else {
                        regionData[lang] = { error: `ไม่พบข้อมูลในภูมิภาค ${lang.toUpperCase()}` };
                    }
                }

                if (!selectedLang || !bestHtmlText) {
                    throw new Error(`ไม่พบสติกเกอร์สำหรับ ID: ${stickerId} ในทุกภูมิภาค`);
                }

                const data = regionData[selectedLang];
                const { title, author, description, price, coins } = data;

                // Get all sticker images
                const { previewImages, stickerIds } = await getAllStickerImages(stickerId, bestHtmlText);
                
                // Auto-detect sticker format
                const stickerFormat = detectStickerFormat(previewImages);

                let priceDisplay = price.includes('0') && coins === 0 ? 'ฟรี' : price;

                const escapedTitle = escapeHtml(title);
                const escapedAuthor = escapeHtml(author);
                const escapedStickerFormat = escapeHtml(stickerFormat);
                const escapedDescription = escapeHtml(description);
                const escapedPriceDisplay = escapeHtml(priceDisplay);

                let regionInfoHtml = '';
                for (const lang of languages) {
                    const region = regionData[lang];
                    if (!region.error) {
                        regionInfoHtml += `
                            <div class="region-info">
                                <p><strong>ภูมิภาค: ${lang.toUpperCase()}</strong></p>
                                <p>ราคา: ${region.price}</p>
                            </div>
                        `;
                    }
                }

                const formatInfo = {
                    'STATIC': 'สติกเกอร์แบบคงที่ (ภาพนิ่ง)',
                    'ANIMATION': 'สติกเกอร์แบบเคลื่อนไหว (ไม่มีเสียง)', 
                    'ANIMATION_SOUND': 'สติกเกอร์แบบเคลื่อนไหวพร้อมเสียง'
                };

                resultDiv.innerHTML = `
                    <img id="stickerImage" src="${imageUrl}" alt="Sticker Image" onerror="this.src='https://via.placeholder.com/180'">
                    <p><strong>ชื่อสติกเกอร์:</strong> ${title}</p>
                    <p><strong>ผู้สร้าง:</strong> ${author}</p>
                    <p><strong>รูปแบบ:</strong> ${stickerFormat}</p>
                    <div class="format-info">${formatInfo[stickerFormat] || 'ไม่ทราบรูปแบบ'}</div>
                    <p><strong>Sticker ID:</strong> ${stickerId}</p>
                    <p><strong>จำนวนสติกเกอร์:</strong> ${previewImages.length || 'ไม่พบข้อมูล'}</p>
                    <p><strong>รายละเอียด:</strong> ${description}</p>
                    <p><strong>ราคา:</strong> ${priceDisplay} ${coins > 0 ? `<img src="https://aliyahaunjo.github.io/image/LINE-COIN.png" class="coin-icon" alt="LINE Coin"> ${coins} Coin` : ''}</p>
                    <button onclick="openSticker('https://store.line.me/stickershop/product/${stickerId}/${selectedLang}')">ดู Sticker ในเบราว์เซอร์</button>
                    <br>
                    <button onclick="shareSticker('https://store.line.me/stickershop/product/${stickerId}/${selectedLang}', '${escapedTitle}', '${escapedAuthor}', ${coins}, '${imageUrl}', '${escapedStickerFormat}', '${escapedPriceDisplay}')">แชร์ Sticker</button>
                    <h4>ข้อมูลตามภูมิภาค</h4>
                    ${regionInfoHtml}
                    <h4>ตัวอย่างสติกเกอร์ (${previewImages.length} ภาพ)</h4>
                    <div id="previewGallery">
                        ${previewImages.length ? previewImages.map((src, i) => `<img src="${src}" alt="Sticker ${i + 1}" title="ID: ${stickerIds[i] || 'N/A'}" onerror="this.style.display='none'">`).join('') : '<p>ไม่มีตัวอย่าง</p>'}
                    </div>
                    ${stickerIds.length > 0 ? `<p>รหัสสติกเกอร์: ${stickerIds.slice(0, 10).join(', ')}${stickerIds.length > 10 ? ` และอีก ${stickerIds.length - 10} รหัส...` : ''}</p>` : ''}
                `;
            } catch (error) {
                console.error('Search error:', error.message);
                resultDiv.innerHTML = `
                    <p>เกิดข้อผิดพลาด: ${error.message}</p>
                    <p>ลอง ID อื่น: <button onclick="document.getElementById('stickerId').value='31552153';searchSticker()">31552153</button></p>
                    <button onclick="document.getElementById('stickerId').value='';document.getElementById('result').innerHTML='';">ค้นหาใหม่</button>
                `;
            } finally {
                loadingSearch.style.display = 'none';
            }
        }

        function openSticker(url) {
            window.open(url, '_blank');
        }

        async function shareSticker(url, title, author, coins, imageUrl, stickerFormat, priceDisplay) {
            try {
                const liffId = '2000563749-VxLJ4OdX';
                const shareUrl = `https://liff.line.me/${liffId}?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}&author=${encodeURIComponent(author)}&coins=${encodeURIComponent(coins)}&imageUrl=${encodeURIComponent(imageUrl)}&stickerFormat=${encodeURIComponent(stickerFormat)}&priceTHB=${encodeURIComponent(priceDisplay)}`;

                if (typeof liff !== 'undefined' && liff.isInClient()) {
                    await liff.ready;
                    if (!liff.isLoggedIn()) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'กรุณาล็อกอิน',
                            text: 'คุณต้องล็อกอินด้วยบัญชี LINE เพื่อแชร์สติกเกอร์',
                            confirmButtonText: 'ล็อกอิน',
                            showCancelButton: true,
                            cancelButtonText: 'ยกเลิก'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                liff.login({ redirectUri: window.location.href });
                            }
                        });
                        return;
                    }

                    if (!liff.isApiAvailable('shareTargetPicker')) {
                        throw new Error('เวอร์ชัน LIFF ไม่รองรับการแชร์');
                    }

                    document.getElementById('main').style.display = 'none';
                    document.getElementById('shareLoader').style.display = 'flex';

                    const flexMessage = createFlexMessage(url, title, author, coins, imageUrl, stickerFormat, priceDisplay, liffId);

                    const result = await liff.shareTargetPicker([{
                        type: "flex",
                        altText: `พบ LINE Sticker: ${title}`,
                        contents: flexMessage
                    }]);

                    if (result) {
                        Swal.fire({
                            icon: 'success',
                            title: 'แชร์สำเร็จ!',
                            text: 'สติกเกอร์ถูกส่งเรียบร้อยแล้ว',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            liff.closeWindow();
                        });
                    } else {
                        Swal.fire({
                            icon: 'warning',
                            title: 'แชร์ถูกยกเลิก',
                            text: 'คุณเลือกไม่แชร์สติกเกอร์',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            liff.closeWindow();
                        });
                    }
                } else {
                    // Fallback for desktop: Copy share URL to clipboard
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'คัดลอกลิงก์สำเร็จ',
                            text: 'ลิงก์สำหรับแชร์สติกเกอร์ถูกคัดลอกไปยังคลิปบอร์ดแล้ว',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }).catch(() => {
                        Swal.fire({
                            icon: 'error',
                            title: 'คัดลอกลิงก์ล้มเหลว',
                            text: 'กรุณาคัดลอกลิงก์ด้วยตนเอง: ' + shareUrl,
                            confirmButtonText: 'ตกลง'
                        });
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message,
                    confirmButtonText: 'ตกลง'
                });
            } finally {
                document.getElementById('shareLoader').style.display = 'none';
            }
        }

        async function handleLiffCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const url = urlParams.get('url');
            const title = urlParams.get('title');
            const author = urlParams.get('author');
            const coins = parseInt(urlParams.get('coins')) || 0;
            const imageUrl = urlParams.get('imageUrl');
            const stickerFormat = urlParams.get('stickerFormat') || 'STATIC';
            const priceTHB = urlParams.get('priceTHB') || '0';

            if (url && title && author && imageUrl) {
                document.getElementById('preloader').style.display = 'none';
                document.getElementById('main').style.display = 'none';
                document.getElementById('shareLoader').style.display = 'flex';
                await shareSticker(
                    decodeURIComponent(url),
                    decodeURIComponent(title),
                    decodeURIComponent(author),
                    coins,
                    decodeURIComponent(imageUrl),
                    decodeURIComponent(stickerFormat),
                    decodeURIComponent(priceTHB)
                );
            }
        }

        function loadLiffScript(callback) {
            const liffUrl = 'https://static.line-scdn.net/liff/edge/2/sdk.js';
            const script = document.createElement('script');
            script.src = liffUrl;
            script.async = true;
            script.onload = () => {
                console.log(`LIFF SDK loaded successfully from ${liffUrl}`);
                callback();
            };
            script.onerror = () => {
                console.error(`Failed to load LIFF SDK from ${liffUrl}`);
                document.getElementById('preloader').style.display = 'none';
                document.getElementById('main').style.display = 'block';
                Swal.fire({
                    icon: 'warning',
                    title: 'LIFF SDK ไม่โหลด',
                    text: 'การแชร์ผ่าน LINE จะไม่ทำงาน แต่คุณยังสามารถค้นหาและดูสติกเกอร์ได้',
                    confirmButtonText: 'ตกลง'
                });
            };
            document.head.appendChild(script);
        }

        window.onload = function() {
            console.log('Page loaded');
            loadLiffScript(async () => {
                const initialized = await initializeLiff();
                document.getElementById('preloader').style.display = 'none';
                document.getElementById('main').style.display = 'block';
                if (initialized) {
                    await handleLiffCallback();
                }
            });

            // Set default values
            document.getElementById('stickerId').value = '31552153';
        };
    </script>
</body>
</html>
